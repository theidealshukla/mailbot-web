<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Internship Email Automation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="src/css/styles.css">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="text-center mb-5">
            <h1><i class="fas fa-envelope-open-text me-3"></i>Internship Email Automation</h1>
            <p class="lead text-muted">Automate personalized email campaigns for internship applications</p>
        </div>

        <!-- Progress Steps -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="progress-steps">
                    <div class="step active" data-step="1">
                        <div class="step-number">1</div>
                        <div class="step-text">Upload Files</div>
                    </div>
                    <div class="step" data-step="2">
                        <div class="step-number">2</div>
                        <div class="step-text">Email Template</div>
                    </div>
                    <div class="step" data-step="3">
                        <div class="step-number">3</div>
                        <div class="step-text">Gmail Setup</div>
                    </div>
                    <div class="step" data-step="4">
                        <div class="step-number">4</div>
                        <div class="step-text">Send Campaign</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 1: File Upload -->
        <div class="step-content" id="step-1">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-upload me-2"></i>Step 1: Upload Your Files</h5>
                </div>
                <div class="card-body">
                    <form id="step1Form">
                        <!-- Resume Upload -->
                        <div class="mb-4">
                            <label for="resume" class="form-label">
                                <i class="fas fa-file-pdf me-2"></i>Upload Your Resume (PDF)
                            </label>
                            <input type="file" class="form-control" id="resume" accept=".pdf" required>
                            <div class="form-text">Upload your resume in PDF format. This will be attached to all emails.</div>
                        </div>

                        <!-- CSV Upload -->
                        <div class="mb-4">
                            <label for="contacts" class="form-label">
                                <i class="fas fa-file-csv me-2"></i>Upload HR Contacts (CSV)
                            </label>
                            <input type="file" class="form-control" id="contacts" accept=".csv" required>
                            <div class="form-text">
                                CSV file must contain columns: <code>name</code>, <code>email</code>, <code>company</code>
                                <br>
                                <a href="#" id="downloadSample" class="text-decoration-none">
                                    <i class="fas fa-download me-1"></i>Download sample CSV
                                </a>
                            </div>
                        </div>

                        <!-- Sender Email -->
                        <div class="mb-4">
                            <label for="senderEmail" class="form-label">
                                <i class="fas fa-envelope me-2"></i>Your Gmail Address
                            </label>
                            <input type="email" class="form-control" id="senderEmail" 
                                   placeholder="your.email@gmail.com" required>
                            <div class="form-text">Enter the Gmail address you'll use to send emails.</div>
                        </div>

                        <!-- Next Button -->
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-arrow-right me-2"></i>Next: Email Template
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Step 2: Email Template -->
        <div class="step-content" id="step-2" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-edit me-2"></i>Step 2: Customize Email Template</h5>
                </div>
                <div class="card-body">
                    <form id="step2Form">
                        <!-- Email Subject Template -->
                        <div class="mb-4">
                            <label for="emailSubject" class="form-label">
                                <i class="fas fa-envelope me-2"></i>Email Subject Template
                            </label>
                            <input type="text" class="form-control" id="emailSubject" 
                                   value="Exploring Internship Opportunities at {company}" required>
                            <div class="form-text">
                                Use <code>{company}</code> for company name, <code>{hr_name}</code> for HR name.
                            </div>
                        </div>

                        <!-- Email Body Template -->
                        <div class="mb-4">
                            <label for="emailBody" class="form-label">
                                <i class="fas fa-align-left me-2"></i>Email Body Template
                            </label>
                            <textarea class="form-control" id="emailBody" rows="12" required>Dear {hr_name},

I hope you're doing well. My name is Adarsh Kumar Shukla, and I'm currently a pre-final year B.Tech Computer Science student. I came across {company}'s work and would love the chance to explore internship opportunities with your team.

A little about me:

-Built an AI-driven customer support portal (with tracking, authentication, and RCA/CAPA suggestions)

-Developed a responsive news website with dynamic content loading

-Hands-on experience with JavaScript, React, Firebase, Supabase, and Python

I'm excited about the possibility of contributing to {company}, while also learning and growing under the guidance of your team. Please let me know if we could connect further about potential opportunities.

Looking forward to your response,
Adarsh Kumar Shukla</textarea>
                            <div class="form-text">
                                Available variables: <code>{hr_name}</code>, <code>{company}</code>, <code>{sender_name}</code>, <code>{sender_email}</code>
                            </div>
                        </div>

                        <!-- Template Preview -->
                        <div class="mb-4">
                            <button type="button" class="btn btn-outline-info" id="previewTemplate">
                                <i class="fas fa-eye me-2"></i>Preview Template
                            </button>
                            <div id="templatePreview" class="mt-3" style="display: none;"></div>
                        </div>

                        <!-- Navigation Buttons -->
                        <div class="row">
                            <div class="col-6">
                                <button type="button" class="btn btn-secondary btn-lg w-100" id="backToStep1">
                                    <i class="fas fa-arrow-left me-2"></i>Back
                                </button>
                            </div>
                            <div class="col-6">
                                <button type="submit" class="btn btn-primary btn-lg w-100">
                                    <i class="fas fa-arrow-right me-2"></i>Next: Gmail Setup
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Step 3: Gmail Authentication -->
        <div class="step-content" id="step-3" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-key me-2"></i>Step 3: Gmail Authentication</h5>
                </div>
                <div class="card-body">
                    <!-- Gmail Setup Instructions -->
                    <div class="alert alert-info">
                        <h6><i class="fas fa-info-circle me-2"></i>Gmail App Password Required</h6>
                        <p class="mb-2">To send emails securely, you need a Gmail App Password:</p>
                        <ol class="mb-0">
                            <li>Enable 2-Factor Authentication on your Google Account</li>
                            <li>Go to <a href="https://myaccount.google.com/security" target="_blank">Google Account Security</a></li>
                            <li>Under "2-Step Verification", click "App passwords"</li>
                            <li>Generate a password for "Other (Custom name)"</li>
                            <li>Copy and paste the 16-character password below</li>
                        </ol>
                    </div>

                    <form id="step3Form">
                        <!-- Gmail App Password -->
                        <div class="mb-4">
                            <label for="gmailPassword" class="form-label">
                                <i class="fas fa-lock me-2"></i>Gmail App Password
                            </label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="gmailPassword" 
                                       placeholder="Paste 16-character app password (no spaces)" 
                                       maxlength="16" required>
                                <button class="btn btn-outline-secondary" type="button" id="togglePassword">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <div class="form-text">
                                Enter your Gmail App Password (NOT your regular password).
                                <br><strong>This password is not stored anywhere and only used for sending emails.</strong>
                                <br><span class="text-info"><i class="fas fa-info-circle me-1"></i>Length: 0/16 characters</span>
                            </div>
                        </div>

                        <!-- Test Connection Button -->
                        <div class="mb-4">
                            <button type="button" class="btn btn-success" id="testConnection">
                                <i class="fas fa-wifi me-2"></i>Test Gmail Connection
                            </button>
                            <div id="connectionStatus" class="mt-2"></div>
                        </div>

                        <!-- Navigation Buttons -->
                        <div class="row">
                            <div class="col-6">
                                <button type="button" class="btn btn-secondary btn-lg w-100" id="backToStep2">
                                    <i class="fas fa-arrow-left me-2"></i>Back
                                </button>
                            </div>
                            <div class="col-6">
                                <button type="submit" class="btn btn-primary btn-lg w-100" disabled id="proceedToStep4">
                                    <i class="fas fa-arrow-right me-2"></i>Send Campaign
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Step 4: Email Sending -->
        <div class="step-content" id="step-4" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-paper-plane me-2"></i>Step 4: Send Email Campaign</h5>
                </div>
                <div class="card-body">
                    <!-- Campaign Summary -->
                    <div id="campaignSummary" class="mb-4"></div>

                    <!-- Email Preview -->
                    <div id="emailPreview" class="mb-4"></div>

                    <!-- Send Campaign Button -->
                    <div class="d-grid mb-4">
                        <button type="button" class="btn btn-success btn-lg" id="startCampaign">
                            <i class="fas fa-rocket me-2"></i>Start Email Campaign
                        </button>
                    </div>

                    <!-- Back Button -->
                    <div class="text-center">
                        <button type="button" class="btn btn-secondary" id="backToStep3">
                            <i class="fas fa-arrow-left me-2"></i>Back to Gmail Setup
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Status Section (for email sending progress) -->
        <div id="emailProgress" class="mt-4" style="display: none;"></div>

        <!-- Instructions -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-question-circle me-2"></i>How It Works</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center">
                            <i class="fas fa-upload fa-2x text-primary mb-3"></i>
                            <h6>1. Upload Files</h6>
                            <p class="small text-muted">Upload resume (PDF), contacts (CSV), and enter Gmail address</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <i class="fas fa-edit fa-2x text-info mb-3"></i>
                            <h6>2. Email Template</h6>
                            <p class="small text-muted">Customize your email subject and body template</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <i class="fas fa-key fa-2x text-success mb-3"></i>
                            <h6>3. Authenticate</h6>
                            <p class="small text-muted">Enter Gmail App Password and verify connection</p>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <i class="fas fa-rocket fa-2x text-warning mb-3"></i>
                            <h6>4. Send Campaign</h6>
                            <p class="small text-muted">Review and send personalized emails with resume attached</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Backend Status -->
        <div class="card mt-4">
            <div class="card-header">
                <h5 class="mb-0"><i class="fas fa-server me-2"></i>Backend API Status</h5>
            </div>
            <div class="card-body">
                <div id="automationStatus" class="alert alert-success">
                    <i class="fas fa-cloud me-2"></i>
                    <strong>� Production Backend Deployed</strong>
                    <ul class="mt-2 mb-0">
                        <li>Backend API hosted on Render: <code>https://coldmailbot-api-1.onrender.com/</code></li>
                        <li>Gmail SMTP integration with resume attachments</li>
                        <li>CSV processing and email personalization</li>
                        <li>Secure password handling (not stored locally)</li>
                        <li>Real-time email sending with progress tracking</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="src/js/api-config.js"></script>
    <script src="src/js/email-config-enhanced.js"></script>
    <script src="src/js/csv-handler.js"></script>
    <script src="src/js/email-sender.js"></script>
    
    <script>
        // Initialize EmailSender when DOM is loaded
        let emailSender;
        
        document.addEventListener('DOMContentLoaded', function() {
            // Show local development tip if needed
            showLocalDevTip();
            
            // Initialize the main EmailSender class
            emailSender = new EmailSender();
            
            // Test API connection on load
            testAPIConnection();
        });
        
        // Show local development tip if needed
        function showLocalDevTip() {
            if (APIConfig.isDevelopment() && !APIConfig.isCompatiblePort()) {
                const container = document.querySelector('.container');
                const tipBanner = document.createElement('div');
                tipBanner.className = 'alert alert-info alert-dismissible fade show';
                tipBanner.innerHTML = `
                    <i class="fas fa-lightbulb me-2"></i>
                    <strong>💡 Local Development Tip:</strong>
                    For best results, run on port 3000: <code>python -m http.server 3000</code>
                    <br>Current: <code>${window.location.origin}</code> | Recommended: <code>http://localhost:3000</code>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                container.insertBefore(tipBanner, container.firstChild);
            }
        }
        
        // Test API connection and update status
        async function testAPIConnection() {
            try {
                const connectionResult = await APIConfig.testConnection();
                const statusElement = document.getElementById('automationStatus');
                
                if (connectionResult.connected) {
                    const method = connectionResult.method === 'proxy' ? ' (via CORS proxy)' : '';
                    statusElement.className = 'alert alert-success';
                    statusElement.innerHTML = `
                        <i class="fas fa-cloud me-2"></i>
                        <strong>🚀 Backend Connected Successfully${method}</strong>
                        <ul class="mt-2 mb-0">
                            <li>Backend API hosted on Render: <code>https://coldmailbot-api-1.onrender.com/</code></li>
                            <li>Gmail SMTP integration with resume attachments</li>
                            <li>CSV processing and email personalization</li>
                            <li>Secure password handling (not stored locally)</li>
                            <li>Real-time email sending with progress tracking</li>
                        </ul>
                        ${connectionResult.method === 'proxy' ? '<div class="mt-2 p-2 bg-info text-white rounded"><small><i class="fas fa-info-circle me-1"></i>Note: Using CORS proxy for GitHub Pages compatibility. Some features may be limited.</small></div>' : ''}
                    `;
                } else {
                    // Check for specific error types
                    const error = connectionResult.error || 'Unknown error';
                    
                    if (error.includes('CORS')) {
                        statusElement.className = 'alert alert-danger';
                        statusElement.innerHTML = `
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <strong>❌ CORS Configuration Issue</strong>
                            <p class="mt-2 mb-2">
                                The backend server needs to be configured to allow requests from GitHub Pages.
                                <br><strong>Current Status:</strong> Backend is running but rejecting cross-origin requests.
                            </p>
                            <div class="mt-3 p-2 bg-light rounded">
                                <strong>🔧 To fix this issue:</strong>
                                <br>• Backend needs to add GitHub Pages domain to CORS allowed origins
                                <br>• Current allowed origin: <code>http://localhost:3000</code>
                                <br>• Needed origin: <code>https://theidealshukla.github.io</code>
                            </div>
                        `;
                    } else {
                        statusElement.className = 'alert alert-warning';
                        statusElement.innerHTML = `
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>⚠️ Backend Connection Issue</strong>
                            <p class="mt-2 mb-2">
                                <strong>Error:</strong> ${error}
                            </p>
                            <p class="mt-2 mb-0">
                                This might be due to:
                                <br>• Backend server is starting up (please wait 1-2 minutes)
                                <br>• Network connectivity issues
                                <br>• Backend maintenance
                            </p>
                            <button class="btn btn-outline-primary btn-sm mt-2" onclick="testAPIConnection()">
                                <i class="fas fa-sync-alt me-1"></i>Retry Connection
                            </button>
                        `;
                    }
                }
            } catch (error) {
                console.error('API connection test failed:', error);
                const statusElement = document.getElementById('automationStatus');
                statusElement.className = 'alert alert-danger';
                statusElement.innerHTML = `
                    <i class="fas fa-times-circle me-2"></i>
                    <strong>❌ Connection Failed</strong>
                    <p class="mt-2 mb-0">Unexpected error: ${error.message}</p>
                `;
            }
        }
        
        // Download sample CSV functionality
        document.getElementById('downloadSample').addEventListener('click', function(e) {
            e.preventDefault();
            
            // Check if CSVHandler is available
            if (typeof CSVHandler !== 'undefined') {
                const csvContent = CSVHandler.generateSampleCSV();
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'sample-hr-contacts.csv';
                a.click();
                window.URL.revokeObjectURL(url);
            } else {
                // Fallback CSV content
                const csvContent = 'name,email,company\\nJohn Doe,john@example.com,Example Corp\\nJane Smith,jane@techstart.com,TechStart Inc';
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'sample-hr-contacts.csv';
                a.click();
                window.URL.revokeObjectURL(url);
            }
        });

        // Toggle password visibility
        document.getElementById('togglePassword').addEventListener('click', function() {
            const passwordInput = document.getElementById('gmailPassword');
            const toggleIcon = this.querySelector('i');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleIcon.className = 'fas fa-eye-slash';
            } else {
                passwordInput.type = 'password';
                toggleIcon.className = 'fas fa-eye';
            }
        });
        
        // Add step navigation buttons event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Back button listeners
            const backToStep1 = document.getElementById('backToStep1');
            if (backToStep1) {
                backToStep1.addEventListener('click', () => showStep(1));
            }
            
            const backToStep2 = document.getElementById('backToStep2');
            if (backToStep2) {
                backToStep2.addEventListener('click', () => showStep(2));
            }
            
            const backToStep3 = document.getElementById('backToStep3');
            if (backToStep3) {
                backToStep3.addEventListener('click', () => showStep(3));
            }
        });
        
        // Function to show specific step
        function showStep(step) {
            // Hide all steps
            for (let i = 1; i <= 4; i++) {
                const stepElement = document.getElementById(`step-${i}`);
                if (stepElement) {
                    stepElement.style.display = 'none';
                }
            }
            
            // Show target step
            const targetStep = document.getElementById(`step-${step}`);
            if (targetStep) {
                targetStep.style.display = 'block';
            }
            
            // Update progress indicators
            updateProgressSteps(step);
        }
        
        // Function to update progress steps visual indicators
        function updateProgressSteps(currentStep) {
            for (let i = 1; i <= 4; i++) {
                const stepElement = document.querySelector(`.step[data-step="${i}"]`);
                if (stepElement) {
                    stepElement.classList.remove('active', 'completed');
                    
                    if (i < currentStep) {
                        stepElement.classList.add('completed');
                    } else if (i === currentStep) {
                        stepElement.classList.add('active');
                    }
                }
            }
        }
    </script>
</body>
</html>